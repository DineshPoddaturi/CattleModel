########################################################
if(i > 3){
  
  # if(quantities_prices_capK$ps[i] > quantities_prices_capK$ps[i-1]){
  #   ps <- (quantities_prices_capK$ps[i] + quantities_prices_capK$ps[i-1] + quantities_prices_capK$ps[i-2])/3
  # }
  # if(quantities_prices_capK$pc[i] > quantities_prices_capK$pc[i-1]){
  #   pc <- (quantities_prices_capK$pc[i] + quantities_prices_capK$pc[i-1] + quantities_prices_capK$pc[i-2])/3
  # }
  
  if(quantities_prices_capK$ps[i] < quantities_prices_capK$ps[i-1]){
    ps <- mean(c(quantities_prices_capK$ps[i], quantities_prices_capK$ps[i-1], quantities_prices_capK$ps[i-2],quantities_prices_capK$ps[i-3]))
  }
  if(quantities_prices_capK$pc[i] < quantities_prices_capK$pc[i-1]){
    pc <- mean(c(quantities_prices_capK$pc[i], quantities_prices_capK$pc[i-1], quantities_prices_capK$pc[i-2],quantities_prices_capK$pc[i-3]))
  }
  
  if(quantities_prices_capK$ps[i] > quantities_prices_capK$ps[i-1]){
    ps <- mean(c(quantities_prices_capK$ps[i], quantities_prices_capK$ps[i-1], quantities_prices_capK$ps[i-2],quantities_prices_capK$ps[i-3]))
  }
  if(quantities_prices_capK$pc[i] > quantities_prices_capK$pc[i-1]){
    pc <- mean(c(quantities_prices_capK$pc[i], quantities_prices_capK$pc[i-1], quantities_prices_capK$pc[i-2],quantities_prices_capK$pc[i-3]))
  }
}

ps_lo <- ps - 0.02492
pc_lo <- pc - 0.03717
ps_expected_lo <- ps_expected - 0.1

ps_up <- ps + 0.23644
pc_up <- pc + 0.192417
ps_expected_up <- ps_expected + 0.1

# > estObsPC
# Year cullPrice        pc           D
# 1  2001 0.5017870 0.4100000  0.09178700
# 2  2002 0.5174800 0.3741667  0.14331333
# 3  2003 0.5393250 0.4295833  0.10974167
# 4  2004 0.5356730 0.5055000  0.03017300
# 5  2005 0.5419789 0.5205833  0.02139556
# 6  2006 0.5640260 0.4674167  0.09660933
# 7  2007 0.5931889 0.4811667  0.11202222
# 8  2008 0.6232260 0.5080000  0.11522600
# 9  2009 0.6465220 0.4485000  0.19802200
# 10 2010 0.6594230 0.5493333  0.11008967
# 11 2011 0.6600630 0.7157500 -0.05568700
# 12 2012 0.6420370 0.8197500 -0.17771300
# 13 2013 0.6625070 0.8229167 -0.16040967
# 14 2014 0.7211500 1.0822500 -0.36110000
# 15 2015 0.7990830 1.0410833 -0.24200033
# 16 2016 0.0000000 0.7489167 -0.74891667
# 17 2017 0.0000000 0.6955833 -0.69558333

# estObsPS
# Year  fedPrice        ps          err
# 1  2001 0.7856324 0.7496667  0.035965697
# 2  2002 0.8726021 0.7012500  0.171352125
# 3  2003 0.9384342 0.8450000  0.093434167
# 4  2004 0.9140052 0.8968333  0.017171833
# 5  2005 0.9294725 0.9408333 -0.011360833
# 6  2006 0.9746378 0.9204167  0.054221167
# 7  2007 1.0231970 0.9538333  0.069363667
# 8  2008 1.0738967 0.9446667  0.129230000
# 9  2009 1.1372110 0.8533333  0.283877667
# 10 2010 1.1644190 0.9723333  0.192085667
# 11 2011 1.1763780 1.1716667  0.004711333
# 12 2012 1.1545020 1.2308333 -0.076331333
# 13 2013 1.1674820 1.2633333 -0.095851333
# 14 2014 1.2219400 1.5433333 -0.321393333
# 15 2015 1.2934820 1.4933333 -0.199851333
# 16 2016 0.0000000 1.2166667 -1.216666667
# 17 2017 0.0000000 1.2191667 -1.219166667
#################################################
A_node <- A * dShockNode

if(norm(x = (c_cull - c_old_cull), type = "f") < 0.003 && norm(x = (c_fed - c_old_fed) , type = "f") < 0.003){
  break
}

ps_lo <- ps - 0.02492
pc_lo <- pc - 0.03717
ps_expected_lo <- ps_expected - 0.1

ps_up <- ps + 0.23644
pc_up <- pc + 0.192417
ps_expected_up <- ps_expected + 0.1

# > estObsPS
# Year  fedPrice        ps         err
# 1  2001 0.5666303 0.7496667 -0.18303633
# 2  2002 0.6315664 0.7012500 -0.06968363
# 3  2003 0.8615493 0.8450000  0.01654933
# 4  2004 0.6297460 0.8968333 -0.26708733
# 5  2005 0.7301623 0.9408333 -0.21067105
# 6  2006 0.8156200 0.9204167 -0.10479667
# 7  2007 0.8357997 0.9538333 -0.11803364
# 8  2008 0.8871271 0.9446667 -0.05753958
# 9  2009 0.9609652 0.8533333  0.10763185
# 10 2010 0.9959653 0.9723333  0.02363200
# 11 2011 0.9888048 1.1716667 -0.18286185
# 12 2012 0.9974485 1.2308333 -0.23338483
# 13 2013 1.0320987 1.2633333 -0.23123461
# 14 2014 1.0962301 1.5433333 -0.44710321
# 15 2015 1.1570067 1.4933333 -0.33632664
# 16 2016 0.0000000 1.2166667 -1.21666667
# 17 2017 0.0000000 1.2191667 -1.21916667

# estObsPC
# Year cullPrice        pc           D
# 1  2001 0.2200167 0.4100000 -0.18998333
# 2  2002 0.3478125 0.3741667 -0.02635417
# 3  2003 0.3292900 0.4295833 -0.10029333
# 4  2004 0.3773250 0.5055000 -0.12817500
# 5  2005 0.3292325 0.5205833 -0.19135083
# 6  2006 0.3712980 0.4674167 -0.09611867
# 7  2007 0.4153233 0.4811667 -0.06584333
# 8  2008 0.4569933 0.5080000 -0.05100667
# 9  2009 0.5027120 0.4485000  0.05421200
# 10 2010 0.4516667 0.5493333 -0.09766667
# 11 2011 0.5080300 0.7157500 -0.20772000
# 12 2012 0.4170267 0.8197500 -0.40272333
# 13 2013 0.4668200 0.8229167 -0.35609667
# 14 2014 0.5415080 1.0822500 -0.54074200
# 15 2015 0.5930275 1.0410833 -0.44805583
# 16 2016 0.0000000 0.7489167 -0.74891667
# 17 2017 0.0000000 0.6955833 -0.69558333
###################################################


if(norm(x = (c_cull - c_old_cull), type = "f") < 0.003 && norm(x = (c_fed - c_old_fed) , type = "f") < 0.003){
  break
}

sl_node <- fedCattleNode 
cl_node <- cullCowNode  
A_node <- (sl_node + cl_node) * dShockNode

ps_lo <- ps - 0.27667
pc_lo <- pc - 0.29217
ps_expected_lo <- ps_expected - 0.1

ps_up <- ps + 0.23644
pc_up <- pc + 0.192417
ps_expected_up <- ps_expected + 0.1

# estObsPS
# Year  fedPrice        ps          err
# 1  2001 0.7898185 0.7496667  0.040151833
# 2  2002 0.8865030 0.7012500  0.185253000
# 3  2003 0.9344192 0.8450000  0.089419200
# 4  2004 0.9138228 0.8968333  0.016989467
# 5  2005 0.9257900 0.9408333 -0.015043333
# 6  2006 0.9717058 0.9204167  0.051289133
# 7  2007 1.0199467 0.9538333  0.066113417
# 8  2008 1.0681480 0.9446667  0.123481333
# 9  2009 1.1372110 0.8533333  0.283877667
# 10 2010 1.1644190 0.9723333  0.192085667
# 11 2011 1.1763780 1.1716667  0.004711333
# 12 2012 1.1545020 1.2308333 -0.076331333
# 13 2013 1.1674820 1.2633333 -0.095851333
# 14 2014 1.2219400 1.5433333 -0.321393333
# 15 2015 1.2934820 1.4933333 -0.199851333
# 16 2016 0.0000000 1.2166667 -1.216666667
# 17 2017 0.0000000 1.2191667 -1.219166667

# estObsPC
# Year cullPrice        pc           D
# 1  2001  0.289875 0.4100000 -0.12012500
# 2  2002  0.302290 0.3741667 -0.07187667
# 3  2003  0.329290 0.4295833 -0.10029333
# 4  2004  0.320395 0.5055000 -0.18510500
# 5  2005  0.328995 0.5205833 -0.19158833
# 6  2006  0.348355 0.4674167 -0.11906167
# 7  2007  0.379935 0.4811667 -0.10123167
# 8  2008  0.407585 0.5080000 -0.10041500
# 9  2009  0.430895 0.4485000 -0.01760500
# 10 2010  0.443790 0.5493333 -0.10554333
# 11 2011  0.444415 0.7157500 -0.27133500
# 12 2012  0.426395 0.8197500 -0.39335500
# 13 2013  0.446875 0.8229167 -0.37604167
# 14 2014  0.505520 1.0822500 -0.57673000
# 15 2015  0.583455 1.0410833 -0.45762833
# 16 2016  0.000000 0.7489167 -0.74891667
# 17 2017  0.000000 0.6955833 -0.69558333

##############################################

ps_lo <- ps - 0.27667
pc_lo <- pc - 0.28000
ps_expected_lo <- ps_expected - 0.1

ps_up <- ps + 0.23644
pc_up <- pc + 0.25933
ps_expected_up <- ps_expected + 0.1

# estObsPS
# Year  fedPrice        ps          err
# 1  2001 0.7115428 0.7496667 -0.038123848
# 2  2002 0.9019090 0.7012500  0.200659000
# 3  2003 0.9564400 0.8450000  0.111440000
# 4  2004 0.9275860 0.8968333  0.030752667
# 5  2005 0.9457320 0.9408333  0.004898667
# 6  2006 0.9904190 0.9204167  0.070002333
# 7  2007 1.0346280 0.9538333  0.080794667
# 8  2008 1.0824190 0.9446667  0.137752333
# 9  2009 1.1372110 0.8533333  0.283877667
# 10 2010 1.1644190 0.9723333  0.192085667
# 11 2011 1.1763780 1.1716667  0.004711333
# 12 2012 1.1545020 1.2308333 -0.076331333
# 13 2013 1.1674820 1.2633333 -0.095851333
# 14 2014 1.2219400 1.5433333 -0.321393333
# 15 2015 1.2934820 1.4933333 -0.199851333
# 16 2016 0.0000000 1.2166667 -1.216666667
# 17 2017 0.0000000 1.2191667 -1.219166667

# estObsPC
# Year cullPrice        pc           D
# 1  2001  0.329415 0.4100000 -0.08058500
# 2  2002  0.341835 0.3741667 -0.03233167
# 3  2003  0.368835 0.4295833 -0.06074833
# 4  2004  0.359935 0.5055000 -0.14556500
# 5  2005  0.368535 0.5205833 -0.15204833
# 6  2006  0.387895 0.4674167 -0.07952167
# 7  2007  0.419475 0.4811667 -0.06169167
# 8  2008  0.447125 0.5080000 -0.06087500
# 9  2009  0.470435 0.4485000  0.02193500
# 10 2010  0.483335 0.5493333 -0.06599833
# 11 2011  0.483955 0.7157500 -0.23179500
# 12 2012  0.465935 0.8197500 -0.35381500
# 13 2013  0.486415 0.8229167 -0.33650167
# 14 2014  0.545065 1.0822500 -0.53718500
# 15 2015  0.622995 1.0410833 -0.41808833
# 16 2016  0.000000 0.7489167 -0.74891667
# 17 2017  0.000000 0.6955833 -0.69558333

################################################

ps_lo <- ps - 0.32417
pc_lo <- pc - 0.386667
ps_expected_lo <- ps_expected - 0.1

ps_up <- ps + 0.10929
pc_up <- pc + 0.192417
ps_expected_up <- ps_expected + 0.1

# estObsPC
# Year cullPrice        pc            D
# 1  2001  0.435960 0.4100000  0.025960000
# 2  2002  0.448375 0.3741667  0.074208333
# 3  2003  0.475375 0.4295833  0.045791667
# 4  2004  0.466480 0.5055000 -0.039020000
# 5  2005  0.522120 0.5205833  0.001536667
# 6  2006  0.301105 0.4674167 -0.166311667
# 7  2007  0.332690 0.4811667 -0.148476667
# 8  2008  0.360335 0.5080000 -0.147665000
# 9  2009  0.383645 0.4485000 -0.064855000
# 10 2010  0.396540 0.5493333 -0.152793333
# 11 2011  0.397165 0.7157500 -0.318585000
# 12 2012  0.379145 0.8197500 -0.440605000
# 13 2013  0.399625 0.8229167 -0.423291667
# 14 2014  0.458270 1.0822500 -0.623980000
# 15 2015  0.536210 1.0410833 -0.504873333
# 16 2016  0.000000 0.7489167 -0.748916667
# 17 2017  0.000000 0.6955833 -0.695583333

# estObsPS
# Year  fedPrice        ps         err
# 1  2001 0.6858161 0.7496667 -0.06385058
# 2  2002 0.7348172 0.7012500  0.03356725
# 3  2003 0.8003851 0.8450000 -0.04461489
# 4  2004 0.7739997 0.8968333 -0.12283367
# 5  2005 0.7931532 0.9408333 -0.14768013
# 6  2006 0.8243093 0.9204167 -0.09610741
# 7  2007 0.8408033 0.9538333 -0.11303000
# 8  2008 0.9552690 0.9446667  0.01060233
# 9  2009 1.0100610 0.8533333  0.15672767
# 10 2010 1.0372690 0.9723333  0.06493567
# 11 2011 1.0492270 1.1716667 -0.12243967
# 12 2012 1.0273530 1.2308333 -0.20348033
# 13 2013 1.0403320 1.2633333 -0.22300133
# 14 2014 1.0947900 1.5433333 -0.44854333
# 15 2015 1.1663320 1.4933333 -0.32700133
# 16 2016 0.0000000 1.2166667 -1.21666667
# 17 2017 0.0000000 1.2191667 -1.21916667

#################################################

ps_lo <- ps - 0.10929
pc_lo <- pc - 0.192417
ps_expected_lo <- ps_expected - 0.1

ps_up <- ps + 0.10929
pc_up <- pc + 0.192417
ps_expected_up <- ps_expected + 0.1

# estObsPS
# Year  fedPrice        ps         err
# 1  2001 0.6796479 0.7496667 -0.07001875
# 2  2002 0.7391722 0.7012500  0.03792222
# 3  2003 0.7889162 0.8450000 -0.05608385
# 4  2004 0.7713247 0.8968333 -0.12550868
# 5  2005 0.7815666 0.9408333 -0.15926671
# 6  2006 0.8200905 0.9204167 -0.10032621
# 7  2007 0.8610730 0.9538333 -0.09276033
# 8  2008 0.9552690 0.9446667  0.01060233
# 9  2009 1.0100610 0.8533333  0.15672767
# 10 2010 1.0372690 0.9723333  0.06493567
# 11 2011 1.0492270 1.1716667 -0.12243967
# 12 2012 1.0273530 1.2308333 -0.20348033
# 13 2013 1.0403320 1.2633333 -0.22300133
# 14 2014 1.0947900 1.5433333 -0.44854333
# 15 2015 1.1663320 1.4933333 -0.32700133
# 16 2016 0.0000000 1.2166667 -1.21666667
# 17 2017 0.0000000 1.2191667 -1.21916667

# estObsPC
# Year cullPrice        pc           D
# 1  2001  0.339750 0.4100000 -0.07025000
# 2  2002  0.352165 0.3741667 -0.02200167
# 3  2003  0.379165 0.4295833 -0.05041833
# 4  2004  0.370270 0.5055000 -0.13523000
# 5  2005  0.378875 0.5205833 -0.14170833
# 6  2006  0.398230 0.4674167 -0.06918667
# 7  2007  0.429815 0.4811667 -0.05135167
# 8  2008  0.457460 0.5080000 -0.05054000
# 9  2009  0.480770 0.4485000  0.03227000
# 10 2010  0.493665 0.5493333 -0.05566833
# 11 2011  0.494290 0.7157500 -0.22146000
# 12 2012  0.476270 0.8197500 -0.34348000
# 13 2013  0.496750 0.8229167 -0.32616667
# 14 2014  0.555395 1.0822500 -0.52685500
# 15 2015  0.633335 1.0410833 -0.40774833
# 16 2016  0.000000 0.7489167 -0.74891667
# 17 2017  0.000000 0.6955833 -0.69558333

###################################################

ps <- mean(c(quantities_prices_capK$ps[i], quantities_prices_capK$ps[i-1],
             quantities_prices_capK$ps[i-2],quantities_prices_capK$ps[i-3]))

pc <- mean(c(quantities_prices_capK$pc[i], quantities_prices_capK$pc[i-1],
             quantities_prices_capK$pc[i-2],quantities_prices_capK$pc[i-3]))

if(norm(x = (c_cull - c_old_cull), type = "f") < 0.002 && norm(x = (c_fed - c_old_fed) , type = "f") < 0.002 ){
  if( (ps_m - ps_old)^2 < 0.001 && (pc_m - pc_old)^2 < 0.001){
    break
  }
}

sl_node <- fedCattleNode 
cl_node <- cullCowNode
A_node <- (sl_node + cl_node) * dShockNode

hc_new <- (((g * (beta^3) * ps_new) + (beta - 1) * pc_new)/(1 + g * beta * (gamma0 + beta * gamma1)))
hc_discounted <- ((1-beta^7)/(1-beta)) * (1 + beta * (g * gamma0 + beta * g * gamma1)) * hc_new

ps_expected <- sum(as.numeric(ps_new) * fedMeshCheb)

B <- ps_new - g * (beta^3) * ps_expected + hc_discounted

ps_lo <- ps - 0.27667
pc_lo <- pc - 0.18
ps_expected_lo <- ps_expected - 0.1

ps_up <- ps + 0.15
pc_up <- pc + 0.25933
ps_expected_up <- ps_expected + 0.1

# estObsPC
# Year cullPrice        pc         err
# 1  2001  0.379415 0.4100000 -0.03058500
# 2  2002  0.391835 0.3741667  0.01766833
# 3  2003  0.418835 0.4295833 -0.01074833
# 4  2004  0.409935 0.5055000 -0.09556500
# 5  2005  0.418535 0.5205833 -0.10204833
# 6  2006  0.437895 0.4674167 -0.02952167
# 7  2007  0.469475 0.4811667 -0.01169167
# 8  2008  0.497125 0.5080000 -0.01087500
# 9  2009  0.520435 0.4485000  0.07193500
# 10 2010  0.533335 0.5493333 -0.01599833

# estObsPS
# Year  fedPrice        ps         err
# 1  2001 0.5653320 0.7496667 -0.18433467
# 2  2002 0.7730429 0.7012500  0.07179288
# 3  2003 0.8276457 0.8450000 -0.01735432
# 4  2004 0.8033660 0.8968333 -0.09346738
# 5  2005 0.7804917 0.9408333 -0.16034162
# 6  2006 0.8531345 0.9204167 -0.06728220
# 7  2007 0.8841225 0.9538333 -0.06971082
# 8  2008 0.7826440 0.9446667 -0.16202267
# 9  2009 1.0507710 0.8533333  0.19743767
# 10 2010 1.0779790 0.9723333  0.10564567

###############################################

ps_lo <- ps - 0.25
pc_lo <- pc - 0.18
ps_expected_lo <- ps_expected - 0.1

ps_up <- ps + 0.15
pc_up <- pc + 0.25933
ps_expected_up <- ps_expected + 0.1

# estObsPS
# Year  fedPrice        ps         err
# 1  2001 0.5786670 0.7496667 -0.17099967
# 2  2002 0.7781109 0.7012500  0.07686088
# 3  2003 0.8299874 0.8450000 -0.01501264
# 4  2004 0.8028297 0.8968333 -0.09400362
# 5  2005 0.7903325 0.9408333 -0.15050083
# 6  2006 0.8553207 0.9204167 -0.06509597
# 7  2007 0.8855645 0.9538333 -0.06826885
# 8  2008 0.7959790 0.9446667 -0.14868767
# 9  2009 1.0507710 0.8533333  0.19743767
# 10 2010 1.0779790 0.9723333  0.10564567

# estObsPC
# Year cullPrice        pc         err
# 1  2001  0.379415 0.4100000 -0.03058500
# 2  2002  0.391835 0.3741667  0.01766833
# 3  2003  0.418835 0.4295833 -0.01074833
# 4  2004  0.409935 0.5055000 -0.09556500
# 5  2005  0.418535 0.5205833 -0.10204833
# 6  2006  0.437895 0.4674167 -0.02952167
# 7  2007  0.469475 0.4811667 -0.01169167
# 8  2008  0.497125 0.5080000 -0.01087500
# 9  2009  0.520435 0.4485000  0.07193500
# 10 2010  0.533335 0.5493333 -0.01599833

##################################################

if(norm(x = (c_cull - c_old_cull), type = "f") < 0.003 && norm(x = (c_fed - c_old_fed) , type = "f") < 0.003 ){
  if( (ps_m - ps_old)^2 < 0.001 && (pc_m - pc_old)^2 < 0.001){
    break
  }
}

ps_lo <- ps - 0.15
pc_lo <- pc - 0.18
ps_expected_lo <- ps_expected - 0.1

ps_up <- ps + 0.15
pc_up <- pc + 0.25933
ps_expected_up <- ps_expected + 0.1

# estObsPS
#     Year  fedPrice        ps         err
# 1  2001 0.6286670 0.7496667 -0.12099967
# 2  2002 0.7841518 0.7012500  0.08290182
# 3  2003 0.8333032 0.8450000 -0.01169677
# 4  2004 0.8073002 0.8968333 -0.08953310
# 5  2005 0.7983804 0.9408333 -0.14245290
# 6  2006 0.8589431 0.9204167 -0.06147353
# 7  2007 0.8890033 0.9538333 -0.06483001
# 8  2008 0.8459790 0.9446667 -0.09868767
# 9  2009 1.0507710 0.8533333  0.19743767
# 10 2010 1.0779790 0.9723333  0.10564567


# estObsPC
#     Year cullPrice        pc         err
# 1  2001  0.379415 0.4100000 -0.03058500
# 2  2002  0.391835 0.3741667  0.01766833
# 3  2003  0.418835 0.4295833 -0.01074833
# 4  2004  0.409935 0.5055000 -0.09556500
# 5  2005  0.418535 0.5205833 -0.10204833
# 6  2006  0.437895 0.4674167 -0.02952167
# 7  2007  0.469475 0.4811667 -0.01169167
# 8  2008  0.497125 0.5080000 -0.01087500
# 9  2009  0.520435 0.4485000  0.07193500
# 10 2010  0.533335 0.5493333 -0.01599833

####################################################################################################

if(i > 3){
  ps <- mean(c(quantities_prices_capK$ps[i], quantities_prices_capK$ps[i-1],
               quantities_prices_capK$ps[i-2],quantities_prices_capK$ps[i-3]))
  
  pc <- mean(c(quantities_prices_capK$pc[i], quantities_prices_capK$pc[i-1],
               quantities_prices_capK$pc[i-2],quantities_prices_capK$pc[i-3]))
}

if(norm(x = (c_cull - c_old_cull), type = "f") < 0.005 && norm(x = (c_fed - c_old_fed) , type = "f") < 0.005){
    break
}

ps_lo <- ps - 0.2
pc_lo <- pc - 0.25

ps_up <- ps + 0.18
pc_up <- pc + 0.19

# ps_lo <- ps - 0.32417
# pc_lo <- pc - 0.386667
ps_expected_lo <- ps_expected

# ps_up <- ps + 0.10929
# pc_up <- pc + 0.25
ps_expected_up <- ps_expected


# estObsPC
#     Year cullPrice        pc          err
# 1  2001 0.3840357 0.4100000 -0.025964286
# 2  2002 0.3964524 0.3741667  0.022285714
# 3  2003 0.4234524 0.4295833 -0.006130952
# 4  2004 0.4145565 0.5055000 -0.090943452
# 5  2005 0.4231607 0.5205833 -0.097422619
# 6  2006 0.4425149 0.4674167 -0.024901786
# 7  2007 0.4740982 0.4811667 -0.007068452
# 8  2008 0.5017440 0.5080000 -0.006255952
# 9  2009 0.5250565 0.4485000  0.076556548
# 10 2010 0.5379524 0.5493333 -0.011380952
# 11 2011 0.5385774 0.7157500 -0.177172619
# 12 2012 0.5205565 0.8197500 -0.299193452
# 13 2013 0.5410357 0.8229167 -0.281880952
# 14 2014 0.5996815 1.0822500 -0.482568452
# 15 2015 0.6776190 1.0410833 -0.363464286
# 16 2016 0.7712232 0.7489167  0.022306548
# 17 2017 0.9044524 0.6955833  0.208869048


# estObsPS
#     Year  fedPrice        ps          err
# 1  2001 0.7419439 0.7496667 -0.007722805
# 2  2002 0.7940336 0.7012500  0.092783566
# 3  2003 0.8715627 0.8450000  0.026562733
# 4  2004 0.8342184 0.8968333 -0.062614951
# 5  2005 0.8593905 0.9408333 -0.081442833
# 6  2006 0.9108104 0.9204167 -0.009606262
# 7  2007 0.9731449 0.9538333  0.019311569
# 8  2008 1.0223279 0.9446667  0.077661213
# 9  2009 1.0755976 0.8533333  0.222264293
# 10 2010 1.1029795 0.9723333  0.130646123
# 11 2011 1.1146191 1.1716667 -0.057047594
# 12 2012 1.0918385 1.2308333 -0.138994837
# 13 2013 1.1061874 1.2633333 -0.157145901
# 14 2014 1.1633718 1.5433333 -0.379961533
# 15 2015 1.2363617 1.4933333 -0.256971683
# 16 2016 1.3395417 1.2166667  0.122875000
# 17 2017 1.4822917 1.2191667  0.263125000

#######################################################

if(i > 2){
  
  ps <- mean(c(quantities_prices_capK$ps[i], quantities_prices_capK$ps[i-1],
               quantities_prices_capK$ps[i-2]))
  
  pc <- mean(c(quantities_prices_capK$pc[i], quantities_prices_capK$pc[i-1],
               quantities_prices_capK$pc[i-2]))
}

ps_lo <- ps - 0.1
pc_lo <- pc - 0.15

ps_up <- ps + 0.18
pc_up <- pc + 0.19

ps_expected_lo <- ps_expected
ps_expected_up <- ps_expected


# estObsPS
#     Year  fedPrice        ps         err
# 1  2001 0.7359227 0.7496667 -0.01374399
# 2  2002 0.7896688 0.7012500  0.08841884
# 3  2003 0.8690283 0.8450000  0.02402827
# 4  2004 0.8304468 0.8968333 -0.06638656
# 5  2005 0.8560387 0.9408333 -0.08479466
# 6  2006 0.9087581 0.9204167 -0.01165858
# 7  2007 0.9727953 0.9538333  0.01896195
# 8  2008 1.0227705 0.9446667  0.07810382
# 9  2009 1.0756342 0.8533333  0.22230090
# 10 2010 1.1029150 0.9723333  0.13058170
# 11 2011 1.1145602 1.1716667 -0.05710645
# 12 2012 1.0917276 1.2308333 -0.13910574
# 13 2013 1.1061333 1.2633333 -0.15719999
# 14 2014 1.1633587 1.5433333 -0.37997465
# 15 2015 1.2363606 1.4933333 -0.25697272
# 16 2016 1.3395417 1.2166667  0.12287500
# 17 2017 1.4822917 1.2191667  0.26312500


# estObsPC
#     Year cullPrice        pc           err
# 1  2001 0.3626071 0.4100000 -0.0473928571
# 2  2002 0.3750238 0.3741667  0.0008571429
# 3  2003 0.4020238 0.4295833 -0.0275595238
# 4  2004 0.3931280 0.5055000 -0.1123720238
# 5  2005 0.4017321 0.5205833 -0.1188511905
# 6  2006 0.4210863 0.4674167 -0.0463303571
# 7  2007 0.4526696 0.4811667 -0.0284970238
# 8  2008 0.4803155 0.5080000 -0.0276845238
# 9  2009 0.5036280 0.4485000  0.0551279762
# 10 2010 0.5165238 0.5493333 -0.0328095238
# 11 2011 0.5171488 0.7157500 -0.1986011905
# 12 2012 0.4991280 0.8197500 -0.3206220238
# 13 2013 0.5196071 0.8229167 -0.3033095238
# 14 2014 0.5782530 1.0822500 -0.5039970238
# 15 2015 0.6561905 1.0410833 -0.3848928571
# 16 2016 0.7497946 0.7489167  0.0008779762
# 17 2017 0.8830238 0.6955833  0.1874404762

##########################################################
if(norm(x = (c_cull - c_old_cull), type = "f") < 0.002 && norm(x = (c_fed - c_old_fed) , type = "f") < 0.002){
  # if( (ps_m - ps_old)^2 < 0.001 && (pc_m - pc_old)^2 < 0.001 ){
  break
  # }
}

ps_lo <- ps - 0.02262
pc_lo <- pc - 0.003938

ps_up <- ps + 0.10929
pc_up <- pc + 0.080153

# ps_lo <- ps - 0.32417
# pc_lo <- pc - 0.386667
ps_expected_lo <- ps_expected - 0.01

# ps_up <- ps + 0.10929
# pc_up <- pc + 0.25
ps_expected_up <- ps_expected + 0.01


# estObsPS
#     Year  fedPrice        ps          err
# 1  2001 0.7117008 0.7496667 -0.037965905
# 2  2002 0.7590982 0.7012500  0.057848168
# 3  2003 0.8174949 0.8450000 -0.027505089
# 4  2004 0.7866541 0.8968333 -0.110179199
# 5  2005 0.8051315 0.9408333 -0.135701786
# 6  2006 0.8544998 0.9204167 -0.065916876
# 7  2007 0.9003788 0.9538333 -0.053454557
# 8  2008 0.9482751 0.9446667  0.003608469
# 9  2009 1.0037134 0.8533333  0.150380061
# 10 2010 1.0320562 0.9723333  0.059722859
# 11 2011 1.0442164 1.1716667 -0.127450224
# 12 2012 1.0215336 1.2308333 -0.209299690
# 13 2013 1.0352134 1.2633333 -0.228119962
# 14 2014 1.0917559 1.5433333 -0.451577451
# 15 2015 1.1650410 1.4933333 -0.328292379
# 16 2016 1.2688317 1.2166667  0.052165000
# 17 2017 1.4115817 1.2191667  0.192415000

# estObsPC
#     Year cullPrice        pc          err
# 1  2001 0.3838640 0.4100000 -0.026136000
# 2  2002 0.3962807 0.3741667  0.022114000
# 3  2003 0.4232807 0.4295833 -0.006302667
# 4  2004 0.4143848 0.5055000 -0.091115167
# 5  2005 0.4229890 0.5205833 -0.097594333
# 6  2006 0.4423432 0.4674167 -0.025073500
# 7  2007 0.4739265 0.4811667 -0.007240167
# 8  2008 0.5015723 0.5080000 -0.006427667
# 9  2009 0.5248848 0.4485000  0.076384833
# 10 2010 0.5377807 0.5493333 -0.011552667
# 11 2011 0.5384057 0.7157500 -0.177344333
# 12 2012 0.5203848 0.8197500 -0.299365167
# 13 2013 0.5408640 0.8229167 -0.282052667
# 14 2014 0.5995098 1.0822500 -0.482740167
# 15 2015 0.6774473 1.0410833 -0.363636000
# 16 2016 0.7710515 0.7489167  0.022134833
# 17 2017 0.9042807 0.6955833  0.208697333

############################################################################################

sl_node <- fedCattleNode 
cl_node <- cullCowNode
A_node <- (sl_node + cl_node)

ps_lo <- ps - 0.02262
pc_lo <- pc - 0.003938

ps_up <- ps + 0.10929
pc_up <- pc + 0.080153

# ps_lo <- ps - 0.32417
# pc_lo <- pc - 0.386667
ps_expected_lo <- ps_expected - 0.01

# ps_up <- ps + 0.10929
# pc_up <- pc + 0.25
ps_expected_up <- ps_expected + 0.01

# estObsPS
#     Year  fedPrice        ps         err
# 1  2001 0.7379567 0.7496667 -0.01171000
# 2  2002 0.7755400 0.7012500  0.07429000
# 3  2003 0.8292900 0.8450000 -0.01571000
# 4  2004 0.8004358 0.8968333 -0.09639750
# 5  2005 0.8185817 0.9408333 -0.12225167
# 6  2006 0.8632692 0.9204167 -0.05714750
# 7  2007 0.9074775 0.9538333 -0.04635583
# 8  2008 0.9552692 0.9446667  0.01060250
# 9  2009 1.0100608 0.8533333  0.15672750
# 10 2010 1.0372692 0.9723333  0.06493583
# 11 2011 1.0492275 1.1716667 -0.12243917
# 12 2012 1.0273525 1.2308333 -0.20348083
# 13 2013 1.0403317 1.2633333 -0.22300167
# 14 2014 1.0947900 1.5433333 -0.44854333
# 15 2015 1.1663317 1.4933333 -0.32700167
# 16 2016 1.2688317 1.2166667  0.05216500
# 17 2017 1.4115817 1.2191667  0.19241500

# estObsPC
#     Year cullPrice        pc          err
# 1  2001 0.4199003 0.4100000  0.009900322
# 2  2002 0.4323124 0.3741667  0.058145776
# 3  2003 0.4593165 0.4295833  0.029733147
# 4  2004 0.4504207 0.5055000 -0.055079255
# 5  2005 0.4590259 0.5205833 -0.061557473
# 6  2006 0.4783762 0.4674167  0.010959546
# 7  2007 0.5099584 0.4811667  0.028791688
# 8  2008 0.5376072 0.5080000  0.029607183
# 9  2009 0.5609190 0.4485000  0.112418973
# 10 2010 0.5738137 0.5493333  0.024480392
# 11 2011 0.5744378 0.7157500 -0.141312229
# 12 2012 0.5564172 0.8197500 -0.263332779
# 13 2013 0.5768971 0.8229167 -0.246019585
# 14 2014 0.6355438 1.0822500 -0.446706199
# 15 2015 0.7134817 1.0410833 -0.327601610
# 16 2016 0.8070848 0.7489167  0.058168107
# 17 2017 0.9403126 0.6955833  0.244729253

##############################################################

sl_node <- fedCattleNode 
cl_node <- cullCowNode
A_node <- A * dShockNode

ps_lo <- ps - 0.02262
pc_lo <- pc - 0.003938

ps_up <- ps + 0.10929
pc_up <- pc + 0.080153

# ps_lo <- ps - 0.32417
# pc_lo <- pc - 0.386667
ps_expected_lo <- ps_expected - 0.01

# ps_up <- ps + 0.10929
# pc_up <- pc + 0.25
ps_expected_up <- ps_expected + 0.01

# estObsPS
#     Year  fedPrice        ps          err
# 1  2001 0.6701374 0.7496667 -0.079529242
# 2  2002 0.7296530 0.7012500  0.028403033
# 3  2003 0.7967355 0.8450000 -0.048264470
# 4  2004 0.7504471 0.8968333 -0.146386193
# 5  2005 0.7935507 0.9408333 -0.147282617
# 6  2006 0.8192203 0.9204167 -0.101196372
# 7  2007 0.8185066 0.9538333 -0.135326692
# 8  2008 0.8722115 0.9446667 -0.072455162
# 9  2009 0.9661830 0.8533333  0.112849629
# 10 2010 0.9996925 0.9723333  0.027359148
# 11 2011 1.0152694 1.1716667 -0.156397270
# 12 2012 0.9767125 1.2308333 -0.254120818
# 13 2013 0.9995672 1.2633333 -0.263766174
# 14 2014 1.0547855 1.5433333 -0.488547848
# 15 2015 1.1227547 1.4933333 -0.370578596
# 16 2016 1.2237810 1.2166667  0.007114295
# 17 2017 1.3351948 1.2191667  0.116028156

# estObsPC
#     Year cullPrice        pc          err
# 1  2001 0.4036405 0.4100000 -0.006359451
# 2  2002 0.4031452 0.3741667  0.028978571
# 3  2003 0.4230543 0.4295833 -0.006529026
# 4  2004 0.4275442 0.5055000 -0.077955831
# 5  2005 0.4168215 0.5205833 -0.103761876
# 6  2006 0.4511439 0.4674167 -0.016272790
# 7  2007 0.5048171 0.4811667  0.023650405
# 8  2008 0.5298608 0.5080000  0.021860779
# 9  2009 0.5359197 0.4485000  0.087419704
# 10 2010 0.5446452 0.5493333 -0.004688095
# 11 2011 0.5418380 0.7157500 -0.173912048
# 12 2012 0.5341140 0.8197500 -0.285636024
# 13 2013 0.5489915 0.8229167 -0.273925141
# 14 2014 0.6092095 1.0822500 -0.473040491
# 15 2015 0.6911765 1.0410833 -0.349906857
# 16 2016 0.7883486 0.7489167  0.039431956
# 17 2017 0.9386035 0.6955833  0.243020190

##################################################################################################################

sl_node <- fedCattleNode 
cl_node <- cullCowNode
A_node <- A * dShockNode

ps_lo <- ps - 0.02262
pc_lo <- pc - 0.003938

ps_up <- ps + 0.10929
pc_up <- pc + 0.080153

# ps_lo <- ps - 0.32417
# pc_lo <- pc - 0.386667
ps_expected_lo <- ps_expected - 0.01

# ps_up <- ps + 0.10929
# pc_up <- pc + 0.25
ps_expected_up <- ps_expected + 0.01

prices_pstemp <- NULL
estPS <- NULL
for(i in 1:ncol(prices_ps)){
  prices_pstemp <- unique(round(prices_ps[,i],6))
  estPS[i] <- mean(prices_pstemp)
}

# estObsPS
#     Year  fedPrice        ps         err
# 1  2001 0.7032008 0.7496667 -0.04646592
# 2  2002 0.7144623 0.7012500  0.01321233
# 3  2003 0.7922248 0.8450000 -0.05277517
# 4  2004 0.7564965 0.8968333 -0.14033683
# 5  2005 0.7772032 0.9408333 -0.16363017
# 6  2006 0.8188914 0.9204167 -0.10152527
# 7  2007 0.8541136 0.9538333 -0.09971973
# 8  2008 0.8969592 0.9446667 -0.04770742
# 9  2009 0.9136559 0.8533333  0.06032259
# 10 2010 0.9511657 0.9723333 -0.02116762
# 11 2011 0.9941025 1.1716667 -0.17756417
# 12 2012 0.9325915 1.2308333 -0.29824183
# 13 2013 0.9563591 1.2633333 -0.30697422
# 14 2014 1.0247058 1.5433333 -0.51862758
# 15 2015 1.0681019 1.4933333 -0.42523144
# 16 2016 1.1610775 1.2166667 -0.05558914
# 17 2017 1.3181307 1.2191667  0.09896400

prices_pctemp <- NULL
estPC <- NULL
for(i in 1:ncol(prices_pc)){
  prices_pctemp <- unique(round(prices_pc[,i],5))
  estPC[i] <- mean(prices_pctemp)
}

# estObsPC
#     Year cullPrice        pc          err
# 1  2001 0.3643200 0.4100000 -0.045680000
# 2  2002 0.3902750 0.3741667  0.016108333
# 3  2003 0.4307550 0.4295833  0.001171667
# 4  2004 0.4083750 0.5055000 -0.097125000
# 5  2005 0.4169850 0.5205833 -0.103598333
# 6  2006 0.4417133 0.4674167 -0.025703333
# 7  2007 0.4679200 0.4811667 -0.013246667
# 8  2008 0.4833967 0.5080000 -0.024603333
# 9  2009 0.5188750 0.4485000  0.070375000
# 10 2010 0.5317750 0.5493333 -0.017558333
# 11 2011 0.5323950 0.7157500 -0.183355000
# 12 2012 0.5143750 0.8197500 -0.305375000
# 13 2013 0.5399067 0.8229167 -0.283010000
# 14 2014 0.5970933 1.0822500 -0.485156667
# 15 2015 0.6714450 1.0410833 -0.369638333
# 16 2016 0.7650450 0.7489167  0.016128333
# 17 2017 0.8982750 0.6955833  0.202691667

estPC <- colMeans(prices_pc) %>% as.data.frame()
# estObsPC
#     Year cullPrice        pc         err
# 1  2001 0.3890418 0.4100000 -0.02095820
# 2  2002 0.3945645 0.3741667  0.02039786
# 3  2003 0.4192327 0.4295833 -0.01035059
# 4  2004 0.4161010 0.5055000 -0.08939902
# 5  2005 0.4126921 0.5205833 -0.10789119
# 6  2006 0.4418144 0.4674167 -0.02560226
# 7  2007 0.4962364 0.4811667  0.01506969
# 8  2008 0.5188468 0.5080000  0.01084680
# 9  2009 0.5248848 0.4485000  0.07638483
# 10 2010 0.5360645 0.5493333 -0.01326881
# 11 2011 0.5366895 0.7157500 -0.17906048
# 12 2012 0.5221010 0.8197500 -0.29764902
# 13 2013 0.5403152 0.8229167 -0.28260151
# 14 2014 0.6005877 1.0822500 -0.48166235
# 15 2015 0.6791635 1.0410833 -0.36191986
# 16 2016 0.7761999 0.7489167  0.02728326
# 17 2017 0.9283067 0.6955833  0.23272333

############################################################################################################################

if(norm(x = (c_cull - c_old_cull), type = "f") < 0.0015 && norm(x = (c_fed - c_old_fed) , type = "f") < 0.0015){
  # if( (ps_m - ps_old)^2 < 0.001 && (pc_m - pc_old)^2 < 0.001 ){
  break
  # }
}

sl_node <- fedCattleNode 
cl_node <- cullCowNode
A_node <- (sl_node + cl_node) * dShockNode

ps_lo <- ps - 0.02262
pc_lo <- pc - 0.003938

ps_up <- ps + 0.15
pc_up <- pc + 0.1

ps_expected_lo <- ps_expected - 0.01

# ps_up <- ps + 0.10929
# pc_up <- pc + 0.25
ps_expected_up <- ps_expected + 0.01

estPS <- colMeans(prices_ps) %>% as.data.frame()

# estObsPS
#     Year  fedPrice        ps          err
# 1  2001 0.7447767 0.7496667 -0.004889939
# 2  2002 0.7902866 0.7012500  0.089036559
# 3  2003 0.8516402 0.8450000  0.006640235
# 4  2004 0.8210411 0.8968333 -0.075792249
# 5  2005 0.8414363 0.9408333 -0.099397050
# 6  2006 0.8882120 0.9204167 -0.032204669
# 7  2007 0.9353412 0.9538333 -0.018492125
# 8  2008 0.9853615 0.9446667  0.040694862
# 9  2009 1.0397128 0.8533333  0.186379454
# 10 2010 1.0679465 0.9723333  0.095613132
# 11 2011 1.0803072 1.1716667 -0.091359428
# 12 2012 1.0572064 1.2308333 -0.173626886
# 13 2013 1.0711957 1.2633333 -0.192137606
# 14 2014 1.1288973 1.5433333 -0.414435996
# 15 2015 1.2035370 1.4933333 -0.289796322
# 16 2016 1.3083722 1.2166667  0.091705549
# 17 2017 1.4522917 1.2191667  0.233125000

estPC <- colMeans(prices_pc) %>% as.data.frame()

# estObsPC
#     Year cullPrice        pc           err
# 1  2001 0.3952051 0.4100000 -0.0147948571
# 2  2002 0.4076218 0.3741667  0.0334551429
# 3  2003 0.4346218 0.4295833  0.0050384762
# 4  2004 0.4257260 0.5055000 -0.0797740238
# 5  2005 0.4343301 0.5205833 -0.0862531905
# 6  2006 0.4536843 0.4674167 -0.0137323571
# 7  2007 0.4852676 0.4811667  0.0041009762
# 8  2008 0.5129135 0.5080000  0.0049134762
# 9  2009 0.5362260 0.4485000  0.0877259762
# 10 2010 0.5491218 0.5493333 -0.0002115238
# 11 2011 0.5497468 0.7157500 -0.1660031905
# 12 2012 0.5317260 0.8197500 -0.2880240238
# 13 2013 0.5522051 0.8229167 -0.2707115238
# 14 2014 0.6108510 1.0822500 -0.4713990238
# 15 2015 0.6887885 1.0410833 -0.3522948571
# 16 2016 0.7823926 0.7489167  0.0334759762
# 17 2017 0.9156218 0.6955833  0.2200384762

############################################################################################################################


ps_max <- max(c(quantities_prices_capK$ps[i], quantities_prices_capK$ps[i-1],
                quantities_prices_capK$ps[i-2], quantities_prices_capK$ps[i-3]))
ps_min <- min(c(quantities_prices_capK$ps[i], quantities_prices_capK$ps[i-1],
                quantities_prices_capK$ps[i-2], quantities_prices_capK$ps[i-3]))

ps <- mean(c(ps_min, ps_max))

pc_max <- max(c(quantities_prices_capK$pc[i], quantities_prices_capK$pc[i-1],
                quantities_prices_capK$pc[i-2], quantities_prices_capK$pc[i-3]))
pc_min <- min(c(quantities_prices_capK$pc[i], quantities_prices_capK$pc[i-1],
                quantities_prices_capK$pc[i-2], quantities_prices_capK$pc[i-3]))

pc <- mean(c(pc_min,pc_max))

if(norm(x = (c_cull - c_old_cull), type = "f") < 0.0015 && norm(x = (c_fed - c_old_fed) , type = "f") < 0.0015){
  # if( (ps_m - ps_old)^2 < 0.001 && (pc_m - pc_old)^2 < 0.001 ){
  break
  # }
}

ps_lo <- ps - 0.05
pc_lo <- pc - 0.005

ps_up <- ps + 0.15
pc_up <- pc + 0.1

# ps_lo <- ps - 0.32417
# pc_lo <- pc - 0.386667
ps_expected_lo <- ps_expected - 0.01

# ps_up <- ps + 0.10929
# pc_up <- pc + 0.25
ps_expected_up <- ps_expected + 0.01

estPS <- colMeans(prices_ps) %>% as.data.frame()

# estObsPS
#     Year  fedPrice        ps          err
# 1  2001 0.7400879 0.7496667 -0.009578732
# 2  2002 0.7871829 0.7012500  0.085932870
# 3  2003 0.8500003 0.8450000  0.005000328
# 4  2004 0.8166595 0.8968333 -0.080173866
# 5  2005 0.8383154 0.9408333 -0.102517978
# 6  2006 0.9077565 0.9204167 -0.012660171
# 7  2007 0.9377500 0.9538333 -0.016083365
# 8  2008 0.9601052 0.9446667  0.015438538
# 9  2009 1.0311866 0.8533333  0.177853284
# 10 2010 1.0653374 0.9723333  0.093004017
# 11 2011 1.0774071 1.1716667 -0.094259550
# 12 2012 1.0421300 1.2308333 -0.188703304
# 13 2013 1.0528766 1.2633333 -0.210456750
# 14 2014 1.1574341 1.5433333 -0.385899197
# 15 2015 1.1885490 1.4933333 -0.304784375
# 16 2016 1.2658173 1.2166667  0.049150619
# 17 2017 1.5075000 1.2191667  0.288333333

estPC <- colMeans(prices_pc) %>% as.data.frame()

# estObsPC
#     Year cullPrice        pc           err
# 1  2001 0.3947500 0.4100000 -0.0152500000
# 2  2002 0.4071667 0.3741667  0.0330000000
# 3  2003 0.4341667 0.4295833  0.0045833333
# 4  2004 0.4298750 0.5055000 -0.0756250000
# 5  2005 0.4360833 0.5205833 -0.0845000000
# 6  2006 0.4568750 0.4674167 -0.0105416667
# 7  2007 0.4948333 0.4811667  0.0136666667
# 8  2008 0.5023750 0.5080000 -0.0056250000
# 9  2009 0.5300833 0.4485000  0.0815833333
# 10 2010 0.5490000 0.5493333 -0.0003333333
# 11 2011 0.5490000 0.7157500 -0.1667500000
# 12 2012 0.5332500 0.8197500 -0.2865000000
# 13 2013 0.5539167 0.8229167 -0.2690000000
# 14 2014 0.6371250 1.0822500 -0.4451250000
# 15 2015 0.6891250 1.0410833 -0.3519583333
# 16 2016 0.7411250 0.7489167 -0.0077916667
# 17 2017 0.9540000 0.6955833  0.2584166667
